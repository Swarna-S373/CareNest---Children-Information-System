<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="custom.css" />
  </head>
  <body class="p-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="HomePage.html">Children Info System</a>
        <div class="ms-auto d-flex align-items-center">
          <span class="me-3 text-secondary"
            >Logged in as: <strong id="navUsername"></strong
          ></span>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <h2>Student Records</h2>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <input
          id="filterName"
          class="form-control"
          type="text"
          placeholder="Filter by Name"
        />
      </div>

      <div class="col-md-3">
        <select id="filterClass" class="form-select">
          <option value="">All Classes</option>
          <option value="I">I</option>
          <option value="II">II</option>
          <option value="III">III</option>
          <option value="IV">IV</option>
          <option value="V">V</option>
          <option value="VI">VI</option>
          <option value="VII">VII</option>
          <option value="VIII">VIII</option>
          <option value="IX">IX</option>
          <option value="X">X</option>
          <option value="XI">XI</option>
          <option value="XII">XII</option>
        </select>
      </div>

      <div class="col-md-3">
        <select id="filterSchool" class="form-select">
          <option value="">All Schools</option>
        </select>
      </div>

      <div class="col-md-3">
        <select id="filterGender" class="form-select">
          <option value="">All Genders</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
    </div>

    <table class="table table-bordered table-hover" id="studentTable">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>DOB</th>
          <th>Age</th>
          <th>Gender</th>
          <th>Father's Name</th>
          <th>Mother's Name</th>
          <th>Mobile</th>
          <th>Address</th>
          <th>Class</th>
          <th>School</th>
          <th>Term 1</th>
          <th>Term 2</th>
          <th>Term 3</th>
          <th>Height (m)</th>
          <th>Weight (kg)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
      } else {
        const payload = JSON.parse(atob(token.split(".")[1]));
        document.getElementById("navUsername").textContent = payload.username;
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });
      let allStudents = [];

      async function loadStudents() {
        const res = await fetch("http://localhost:5000/api/students");
        const data = await res.json();
        allStudents = data;
        displayStudents(data);
        populateSchoolFilter(data);
      }

      function getAge(dob) {
        const birth = new Date(dob);
        const diff = Date.now() - birth.getTime();
        const age = new Date(diff).getUTCFullYear() - 1970;
        return age;
      }

      function displayStudents(students) {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";

        students.forEach((stu) => {
          tableBody.innerHTML += `
          <tr>
            <td>${stu.name}</td>
            <td>${new Date(stu.dob).toLocaleDateString()}</td>
            <td>${getAge(stu.dob)}</td>
            <td>${stu.gender}</td>
            <td>${stu.fatherName}</td>
            <td>${stu.motherName}</td>
            <td>${stu.mobile}</td>
            <td>${stu.address}</td>
            <td>${stu.studentClass}</td>
            <td>${stu.schoolName}</td>
            <td>${stu.term1}</td>
            <td>${stu.term2}</td>
            <td>${stu.term3}</td>
            <td>${stu.height}</td>
            <td>${stu.weight}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-warning me-7" onclick="editStudent('${
                stu._id
              }')"><i class="bi bi-pencil-square"></i>Edit</button> 
              <button class="btn btn-sm btn-danger" onclick="deleteStudent('${
                stu._id
              }')"><i class="bi bi-trash"></i>Delete</button>
            </td>
          </tr>
        `;
        });
      }

      function populateSchoolFilter(students) {
        const schoolSelect = document.getElementById("filterSchool");
        const schools = [...new Set(students.map((s) => s.schoolName))];
        schools.forEach((school) => {
          const option = document.createElement("option");
          option.value = school;
          option.textContent = school;
          schoolSelect.appendChild(option);
        });
      }

      function filterStudents() {
        const nameFilter = document
          .getElementById("filterName")
          .value.toLowerCase();
        const classFilter = document.getElementById("filterClass").value;
        const schoolFilter = document.getElementById("filterSchool").value;
        const genderFilter = document.getElementById("filterGender").value;

        const filtered = allStudents.filter((student) => {
          return (
            (!nameFilter || student.name.toLowerCase().includes(nameFilter)) &&
            (!classFilter || student.studentClass === classFilter) &&
            (!schoolFilter || student.schoolName === schoolFilter) &&
            (!genderFilter || student.gender === genderFilter)
          );
        });

        displayStudents(filtered);
      }

      document
        .getElementById("filterName")
        .addEventListener("input", filterStudents);
      document
        .getElementById("filterClass")
        .addEventListener("change", filterStudents);
      document
        .getElementById("filterSchool")
        .addEventListener("change", filterStudents);
      document
        .getElementById("filterGender")
        .addEventListener("change", filterStudents);

      function editStudent(id) {
        window.location.href = `edit.html?id=${id}`;
      }

      async function deleteStudent(id) {
        if (!confirm("Are you sure you want to delete this student?")) return;
        await fetch(`http://localhost:5000/api/students/${id}`, {
          method: "DELETE",
        });
        loadStudents();
      }

      window.onload = loadStudents;
    </script>
  </body>
</html>
