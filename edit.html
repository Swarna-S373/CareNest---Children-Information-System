<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Edit Student</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="custom.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="HomePage.html">Children Info System</a>
        <div class="ms-auto d-flex align-items-center">
          <span class="me-3 text-secondary"
            >Logged in as: <strong id="navUsername"></strong
          ></span>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container">
      <h2 class="mb-4">Edit Student</h2>

      <form id="editForm">
        <input type="hidden" id="studentId" />

        <div class="mb-2">
          <label for="name" class="form-label">Name</label>
          <input class="form-control" id="name" required />
        </div>

        <div class="mb-2">
          <label for="dob" class="form-label">Date of Birth</label>
          <input class="form-control" id="dob" type="date" required />
        </div>

        <div class="mb-2">
          <label class="form-label">Gender</label><br />
          <input type="radio" name="gender" value="male" id="male" />
          <label for="male">Male</label>
          <input type="radio" name="gender" value="female" id="female" />
          <label for="female">Female</label>
        </div>

        <div class="mb-2">
          <label for="fatherName" class="form-label">Father's Name</label>
          <input class="form-control" id="fatherName"  />
        </div>

        <div class="mb-2">
          <label for="motherName" class="form-label">Mother's Name</label>
          <input class="form-control" id="motherName"  />
        </div>

        <div class="mb-2">
          <label for="mobile" class="form-label">Mobile Number</label>
          <input class="form-control" id="mobile" required />
        </div>

        <div class="mb-2">
          <label for="address" class="form-label">Address</label>
          <textarea class="form-control" id="address" required></textarea>
        </div>

        <div class="mb-2">
          <label for="studentClass" class="form-label">Class</label>
          <input class="form-control" id="studentClass" required />
        </div>

        <div class="mb-2">
          <label for="schoolName" class="form-label">School Name</label>
          <textarea class="form-control" id="schoolName" required></textarea>
        </div>

        <div class="mb-2">
          <label for="term1" class="form-label">Term 1 Marks</label>
          <input
            class="form-control"
            type="number"
            id="term1"
            min="0"
            max="100"
          />
        </div>

        <div class="mb-2">
          <label for="term2" class="form-label">Term 2 Marks</label>
          <input
            class="form-control"
            type="number"
            id="term2"
            min="0"
            max="100"
          />
        </div>

        <div class="mb-2">
          <label for="term3" class="form-label">Term 3 Marks</label>
          <input
            class="form-control"
            type="number"
            id="term3"
            min="0"
            max="100"
          />
        </div>

        <div class="mb-2">
          <label for="height" class="form-label">Height (in meters)</label>
          <input
            class="form-control"
            type="number"
            id="height"
            step="0.01"
            min="0.5"
          />
        </div>

        <div class="mb-3">
          <label for="weight" class="form-label">Weight (in kg)</label>
          <input
            class="form-control"
            type="number"
            id="weight"
            step="0.01"
            min="18"
            max="100"
          />
        </div>

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-save"></i>Update
        </button>
        <a class="btn btn-secondary ms-2" href="display.html"
          ><i class="bi bi-arrow-left-circle"></i>Back</a
        >
      </form>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
      } else {
        const payload = JSON.parse(atob(token.split(".")[1]));
        document.getElementById("navUsername").textContent = payload.username;
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });
      const urlParams = new URLSearchParams(window.location.search);
      const studentId = urlParams.get("id");

      async function loadStudent() {
        const res = await fetch(
          `http://localhost:5000/api/students/${studentId}`
        );
        const data = await res.json();

        document.getElementById("studentId").value = data._id;
        document.getElementById("name").value = data.name;
        document.getElementById("dob").value = data.dob;
        document.getElementById(data.gender).checked = true;
        document.getElementById("fatherName").value = data.fatherName;
        document.getElementById("motherName").value = data.motherName;
        document.getElementById("mobile").value = data.mobile;
        document.getElementById("address").value = data.address;
        document.getElementById("studentClass").value = data.studentClass;
        document.getElementById("schoolName").value = data.schoolName;
        document.getElementById("term1").value = data.term1;
        document.getElementById("term2").value = data.term2;
        document.getElementById("term3").value = data.term3;
        document.getElementById("height").value = data.height;
        document.getElementById("weight").value = data.weight;
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const gender = document.querySelector(
            'input[name="gender"]:checked'
          )?.value;

          const updatedStudent = {
            name: document.getElementById("name").value,
            dob: document.getElementById("dob").value,
            gender,
            fatherName: document.getElementById("fatherName").value,
            motherName: document.getElementById("motherName").value,
            mobile: document.getElementById("mobile").value,
            address: document.getElementById("address").value,
            studentClass: document.getElementById("studentClass").value,
            schoolName: document.getElementById("schoolName").value,
            term1: parseFloat(document.getElementById("term1").value),
            term2: parseFloat(document.getElementById("term2").value),
            term3: parseFloat(document.getElementById("term3").value),
            height: parseFloat(document.getElementById("height").value),
            weight: parseFloat(document.getElementById("weight").value),
          };

          const res = await fetch(
            `http://localhost:5000/api/students/${studentId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedStudent),
            }
          );

          const result = await res.json();
          alert(result.message || "Updated successfully");
          window.location.href = "display.html";
        });

      window.onload = loadStudent;
    </script>
  </body>
</html>
